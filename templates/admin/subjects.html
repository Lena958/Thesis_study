<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CCISS Loader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/subjects.css') }}" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/brand.png') }}">

    <style>
        .instructor-group { background-color: #f8fafc; }
        .instructor-name { font-weight: 600; background-color: #e8f0fe; vertical-align: top; }
        .program-cell { font-weight: 500; vertical-align: top; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px 12px; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-small { padding: 4px 8px; font-size: 0.8rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        .close { cursor: pointer; float: right; font-size: 1.2rem; border: none; background: none; }
        .flash-message { margin: 10px 0; padding: 10px; background-color: #f0f4f8; border-left: 4px solid #2196F3; }
    </style>
</head>

<body>
    <!-- Topbar -->
    <div class="topbar">
        <h1>College of Computing and Information Sciences</h1>

        <div class="topbar-profile">
            {% if instructor_image %}
                <img src="{{ url_for('static', filename='uploads/' + instructor_image) }}" alt="Profile" class="profile-pic" />
            {% else %}
                <i class="fas fa-user-circle profile-icon"></i>
            {% endif %}
            <a href="#" id="logoutBtn" class="logout-btn" title="Logout">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-user">
            <img src="{{ url_for('static', filename='images/brand.png') }}" alt="CCISS Logo" class="sidebar-logo">
            {% if instructor_name %}
                <p><strong>{{ instructor_name }}</strong></p>
            {% else %}
                <p><em>Instructor name not found</em></p>
            {% endif %}
        </div>
        <a href="{{ url_for('dashboard.admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="{{ url_for('admin.profile') }}"><i class="fas fa-user"></i> Profile</a>
        <a href="{{ url_for('instructors.list_instructors') }}"><i class="fas fa-chalkboard-teacher"></i> Instructors</a>
        <a href="{{ url_for('courses.list_courses') }}"><i class="fas fa-book"></i> Courses</a>
        <a href="{{ url_for('rooms.list_rooms') }}"><i class="fas fa-door-open"></i> Rooms</a>
        <a href="{{ url_for('subjects.list_subjects') }}"><i class="fas fa-book"></i> CCISS Loader</a>
        <a href="{{ url_for('auto_scheduler.auto_scheduler_home') }}"><i class="fas fa-cogs"></i> Auto-Scheduler</a>
        <a href="{{ url_for('schedules.list_schedules') }}"><i class="fas fa-calendar-alt"></i> Schedules</a>
        <a href="{{ url_for('conflicts.list_conflicts') }}"><i class="fas fa-exclamation-triangle"></i> Conflicts</a>     
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="welcome-card">
            <h2>Admin, {{ instructor_name or 'Instructor' }}!</h2>
            <p>Here's where you can assign subjects to each instructor while keeping their loads within the maximum allowed units.</p>
        </div>

        <div class="table-header">
            <a href="{{ url_for('subjects.add_subject') }}" class="btn">Load New Subject</a>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flash-message">{{ messages[0] }}</div>
            {% endif %}
        {% endwith %}

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Instructor</th>
                        <th>Program</th>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Units</th>
                        <th>Year Level</th>
                        <th>Section</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if subjects %}
                        {% set instructors = {} %}
                        {% for subject in subjects %}
                            {% set key = subject.instructor_name or "Unassigned" %}
                            {% if key not in instructors %}{% set _ = instructors.update({key: []}) %}{% endif %}
                            {% set _ = instructors[key].append(subject) %}
                        {% endfor %}

                        {% for instructor_name, instructor_subjects in instructors.items() %}
                            {% set program_groups = {} %}
                            {% for subject in instructor_subjects %}
                                {% set prog = subject.course or "N/A" %}
                                {% if prog not in program_groups %}{% set _ = program_groups.update({prog: []}) %}{% endif %}
                                {% set _ = program_groups[prog].append(subject) %}
                            {% endfor %}

                            {% set total_rows = instructor_subjects|length %}
                            {% set first_program = instructor_subjects[0].course or "N/A" %}
                            {% set first_program_subjects = program_groups[first_program] %}
                            {% set first_rowspan = first_program_subjects|length %}

                            <!-- First row -->
                            <tr class="instructor-group">
                                <td rowspan="{{ total_rows }}" class="instructor-name">{{ instructor_name }}</td>
                                <td rowspan="{{ first_rowspan }}" class="program-cell">{{ first_program }}</td>
                                <td>{{ instructor_subjects[0].code }}</td>
                                <td>{{ instructor_subjects[0].name }}</td>
                                <td>{{ instructor_subjects[0].units }}</td>
                                <td>{{ instructor_subjects[0].year_level }}</td>
                                <td>{{ instructor_subjects[0].section }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('subjects.edit_subject', subject_id=instructor_subjects[0].subject_id) }}" class="btn btn-small">Edit</a>
                                        <button type="button" class="btn btn-danger btn-small deleteBtn" data-subject-id="{{ instructor_subjects[0].subject_id }}" data-subject-name="{{ instructor_subjects[0].name }}">Delete</button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Remaining rows for first program -->
                            {% for i in range(1, first_program_subjects|length) %}
                                {% set sub = first_program_subjects[i] %}
                                <tr>
                                    <td>{{ sub.code }}</td>
                                    <td>{{ sub.name }}</td>
                                    <td>{{ sub.units }}</td>
                                    <td>{{ sub.year_level }}</td>
                                    <td>{{ sub.section }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('subjects.edit_subject', subject_id=sub.subject_id) }}" class="btn btn-small">Edit</a>
                                            <button type="button" class="btn btn-danger btn-small deleteBtn" data-subject-id="{{ sub.subject_id }}" data-subject-name="{{ sub.name }}">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}

                            {% set displayed_programs = [first_program] %}
                            {% for prog, prog_subjects in program_groups.items() %}
                                {% if prog not in displayed_programs %}
                                    <tr>
                                        <td rowspan="{{ prog_subjects|length }}" class="program-cell">{{ prog }}</td>
                                        <td>{{ prog_subjects[0].code }}</td>
                                        <td>{{ prog_subjects[0].name }}</td>
                                        <td>{{ prog_subjects[0].units }}</td>
                                        <td>{{ prog_subjects[0].year_level }}</td>
                                        <td>{{ prog_subjects[0].section }}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="{{ url_for('subjects.edit_subject', subject_id=prog_subjects[0].subject_id) }}" class="btn btn-small">Edit</a>
                                                <button type="button" class="btn btn-danger btn-small deleteBtn" data-subject-id="{{ prog_subjects[0].subject_id }}" data-subject-name="{{ prog_subjects[0].name }}">Delete</button>
                                            </div>
                                        </td>
                                    </tr>

                                    {% for i in range(1, prog_subjects|length) %}
                                        {% set sub = prog_subjects[i] %}
                                        <tr>
                                            <td>{{ sub.code }}</td>
                                            <td>{{ sub.name }}</td>
                                            <td>{{ sub.units }}</td>
                                            <td>{{ sub.year_level }}</td>
                                            <td>{{ sub.section }}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('subjects.edit_subject', subject_id=sub.subject_id) }}" class="btn btn-small">Edit</a>
                                                    <button type="button" class="btn btn-danger btn-small deleteBtn" data-subject-id="{{ sub.subject_id }}" data-subject-name="{{ sub.name }}">Delete</button>
                                                    <a href="{{ url_for('subjects.view_subject', subject_id=sub.subject_id) }}" class="btn btn-secondary btn-small">View</a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    {% set _ = displayed_programs.append(prog) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="8" style="text-align:center;">No subjects found.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <button class="close cancelBtn" aria-label="Close delete modal">&times;</button>
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete <strong id="subjectName"></strong>?</p>
            <form id="deleteForm" method="POST">
                <button type="submit" class="btn btn-danger">Delete</button>
                <button type="button" class="btn btn-secondary cancelBtn">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <button class="close cancelBtn" aria-label="Close logout modal">&times;</button>
            <h3>Confirm Logout</h3>
            <p>Are you sure you want to logout?</p>
            <form id="logoutForm" method="GET" action="{{ url_for('logout') }}">
                <button type="submit" class="btn btn-danger">Logout</button>
                <button type="button" class="btn btn-secondary cancelBtn">Cancel</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const deleteModal = document.getElementById('deleteModal');
        const logoutModal = document.getElementById('logoutModal');
        const subjectNameEl = document.getElementById('subjectName');
        const deleteForm = document.getElementById('deleteForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const clearBtn = document.querySelector('.clear-btn');
        const searchInput = document.getElementById('subjectSearch');

        // Delete buttons
        document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                subjectNameEl.innerText = btn.dataset.subjectName;
                deleteForm.action = `/admin/subjects/delete/${btn.dataset.subjectId}`;
                deleteModal.style.display = 'block';
            });
        });

        // Modal close/cancel
        deleteModal.querySelectorAll('.close, .cancelBtn').forEach(btn => {
            btn.addEventListener('click', () => deleteModal.style.display = 'none');
        });
        logoutModal.querySelectorAll('.close, .cancelBtn').forEach(btn => {
            btn.addEventListener('click', () => logoutModal.style.display = 'none');
        });

        // Logout modal
        logoutBtn.addEventListener('click', e => {
            e.preventDefault();
            logoutModal.style.display = 'block';
        });

        // Click outside modal closes it using globalThis
        globalThis.addEventListener('click', e => {
            if (e.target === deleteModal) deleteModal.style.display = 'none';
            if (e.target === logoutModal) logoutModal.style.display = 'none';
        });

        // Search filter
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                const filter = searchInput.value.toLowerCase();
                document.querySelectorAll('.table-container tbody tr').forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
                });
                if (clearBtn) clearBtn.style.display = searchInput.value ? 'block' : 'none';
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchInput.focus();
                document.querySelectorAll('.table-container tbody tr').forEach(row => row.style.display = '');
                clearBtn.style.display = 'none';
            });
        }
    });
    </script>

</body>
</html>

